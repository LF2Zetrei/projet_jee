<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>Portfolios</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<h1>Portfolios:</h1>
<h2><a th:href="@{/user}">Ma page utilisateur</a></h2>
<ul id="portfolio-list">
    <li th:each="portfolio : ${portfolios}" th:attr="data-portfolio-id=${portfolio.id}">
        <h3 th:text="${portfolio.title}">Titre du Portfolio</h3>
        <h2 th:text="${portfolio.description}">Description du Portfolio</h2>

        <form onsubmit="event.preventDefault(); modifyPortfolio(this);">
            <div><label>Title: <input type="text" name="title" th:value="${portfolio.title}"/></label></div>
            <div><label>Description: <input type="text" name="description" th:value="${portfolio.description}"/></label></div>
            <input type="hidden" name="id" th:value="${portfolio.id}"/>
            <div><input type="submit" value="modifier"/></div>
        </form>
        <div><label>estPublic: <input type="checkbox" name="estPublic" th:action="@{/portfolios/switchPublic(id=${portfolio.id})}"/></label></div>
        <ul>
            <li th:each="project : ${portfolio.projects}">
                <h3 th:text="${project.title}">Titre du projet</h3>
                <p th:text="${project.description}">Description du projet</p>
            </li>
        </ul>
        <h3><a th:href="@{/portfolios/modifPortfolio(id=${portfolio.id})}">Modifier ce portfolio</a></h3>
        <button type="button" th:onclick="'deletePortfolio(' + ${portfolio.id} + ')'">Supprimer</button>
    </li>
</ul>

<h1>Créer un nouveau portfolio</h1>
<form id="create-portfolio-form" onsubmit="event.preventDefault(); createPortfolio(this)">
    <div><label>Titre : <input type="text" name="title" required/></label></div>
    <div><label>Description : <input type="text" name="description" required/></label></div>
    <div><input type="submit" value="Enregistrer"/></div>
</form>

<script>
    function deletePortfolio(portfolioId){
        const csrfToken = $("meta[name='_csrf']").attr("content");
        const csrfHeader = $("meta[name='_csrf_header']").attr("content");
        $.ajax({
            url: `/portfolios/delete?id=${portfolioId}`, // envoie l'ID du projet en paramètre
            type: 'DELETE',
            beforeSend: function(xhr) {
                xhr.setRequestHeader(csrfHeader, csrfToken);
            },
            success: function() {
                $(`li[data-portfolio-id="${portfolioId}"]`).remove(); // Retire l'élément de la liste
            },
            error: function(xhr, status, error) {
                console.error("Erreur lors de la suppression du projet. Détails de l'erreur:");
                console.error("Statut:", status);
                console.error("Erreur:", error);
                console.error("Réponse complète:", xhr.responseText);
            }
        });
    }
    function modifyPortfolio(form) {
        // Sérialise les données du formulaire
        const formData = $(form).serialize();
        const portfolioId = $(form).find("input[name='id']").val();

        // Validation côté client : vérifier les champs requis
        const title = $(form).find("input[name='title']").val();
        const description = $(form).find("input[name='description']").val();


        // Récupère les tokens CSRF
        const csrfToken = $("meta[name='_csrf']").attr("content");
        const csrfHeader = $("meta[name='_csrf_header']").attr("content");

        // Envoi de la requête AJAX
        $.ajax({
            url: '/portfolios/modif',
            type: 'PUT',
            data: formData,
            beforeSend: function (xhr) {
                xhr.setRequestHeader(csrfHeader, csrfToken); // Ajoute le token CSRF dans l'en-tête
            },
            success: function (response) {
                // Met à jour les informations affichées dans l'interface utilisateur
                const portfolioItem = $(`[data-portfolio-id='${portfolioId}']`);
                portfolioItem.find('h3').text(response.title); // Met à jour le titre
                portfolioItem.find('h2').text(response.description); // Met à jour la description

            },
            error: function (xhr, status, error) {
                console.error("Erreur lors de la mise à jour du portfolio :", xhr.responseText);
                // Affiche une notification d'erreur à l'utilisateur
                alert("Une erreur est survenue lors de la modification du portfolio. Veuillez réessayer.");
            }
        });
    }
    function createPortfolio(form) {
        const formData = $(form).serialize();
        const csrfToken = $("meta[name='_csrf']").attr("content");
        const csrfHeader = $("meta[name='_csrf_header']").attr("content");

        $.ajax({
            url: '/portfolios/modifPortfolio',
            type: 'POST',
            data: formData,
            dataType: "json",
            contentType: "application/x-www-form-urlencoded",
            beforeSend: function(xhr) {
                xhr.setRequestHeader(csrfHeader, csrfToken);
                xhr.setRequestHeader("Accept", "application/json");
            },
            success: function(response) {
                // Ajout du nouveau portfolio à la liste des portfolios
                $('#portfolio-list').append(`
                <li data-portfolio-id="${response.id}">
                    <h3>${response.title}</h3>
                    <h2>${response.description}</h2>
                    <form onsubmit="event.preventDefault(); modifyPortfolio(this);">
                        <div><label>Title: <input type="text" name="title" value="${response.title}" required/></label></div>
                        <div><label>Description: <input type="text" name="description" value="${response.description}" required/></label></div>
                        <input type="hidden" name="id" value="${response.id}"/>
                        <div><input type="submit" value="modifier"/></div>
                    </form>
                    <div><label>estPublic: <input type="checkbox" name="estPublic" th:action="@{/portfolios/switchPublic}"/></label></div>
                    <ul id="project-list-${response.id}"></ul>
                    <h3><a href="/portfolios/modifPortfolio?id=${response.id}">Modifier ce portfolio</a></h3>
                    <button onclick="deletePortfolio(${response.id})">Supprimer</button>
                </li>
            `);

            },
            error: function(xhr, status, error) {
                console.error("Erreur lors de la création du projet. Détails de l'erreur:");
                console.error("Statut:", status);
                console.error("Erreur:", error);
                console.error("Réponse complète:", xhr.responseText);
            }
        });
    }
</script>

</body>
</html>