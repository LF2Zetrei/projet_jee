<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>Modification Portfolio</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> <!-- Ajout de jQuery -->
</head>
<body>
<a th:href="@{/portfolios/myPortfolio}">Mes portfolios</a>
<h2><a th:href="@{/user}">Ma page utilisateur</a></h2>

<h1>Créer un projet pour le portfolio : <span th:text="${portfolio.title}"></span></h1>

<form onsubmit="event.preventDefault(); createProject(this)">
    <div><label>Title: <input type="text" name="title" required/></label></div>
    <div><label>Description: <input type="text" name="description" required/></label></div>
    <input type="hidden" name="id" th:value="${portfolio.id}"/>
    <div><input type="submit" value="Register"/></div>
</form>

<h3>Projets du Portfolio</h3>
<ul id="project-list">
    <li th:each="project : ${portfolio.projects}" th:attr="data-project-id=${project.id}">
        <h3 th:text="${project.title}">Titre du projet</h3>
        <p th:text="${project.description}">Description du projet</p>
        <form onsubmit="event.preventDefault(); modifyProject(this);">
            <div><label>Title: <input type="text" name="title" th:value="${project.title}"/></label></div>
            <div><label>Description: <input type="text" name="description" th:value="${project.description}"/></label></div>
            <input type="hidden" name="id" th:value="${project.id}"/>
            <div><input type="submit" value="modifier"/></div>
        </form>
        <button th:onclick="|deleteProject(${project.id})|">Supprimer</button>
    </li>
</ul>

<script>
    function deleteProject(projectId) {
        const csrfToken = $("meta[name='_csrf']").attr("content");
        const csrfHeader = $("meta[name='_csrf_header']").attr("content");
        $.ajax({
            url: `/projects/delete?id=${projectId}`, // envoie l'ID du projet en paramètre
            type: 'DELETE',
            beforeSend: function(xhr) {
                xhr.setRequestHeader(csrfHeader, csrfToken);
            },
            success: function() {
                $(`li[data-project-id="${projectId}"]`).remove(); // Retire l'élément de la liste
            },
            error: function(xhr, status, error) {
                console.error("Erreur lors de la suppression du projet. Détails de l'erreur:");
                console.error("Statut:", status);
                console.error("Erreur:", error);
                console.error("Réponse complète:", xhr.responseText);
            }
        });

    }
    function createProject(form) {
        const formData = $(form).serialize();
        const csrfToken = $("meta[name='_csrf']").attr("content");
        const csrfHeader = $("meta[name='_csrf_header']").attr("content");

        $.ajax({
            url: '/projects/create',
            type: 'POST',
            data: formData,
            dataType: "json",
            contentType: "application/x-www-form-urlencoded",
            beforeSend: function(xhr) {
                xhr.setRequestHeader(csrfHeader, csrfToken);
                xhr.setRequestHeader("Accept", "application/json");
            },
            success: function(response) {
                console.log("Projet créé avec succès:", response);
                if (response && response.id && response.title && response.description) {
                    $('#project-list').append(`
                <li data-project-id="${response.id}">
                    <h3>${response.title}</h3>
                    <p>${response.description}</p>
                    <form onsubmit="event.preventDefault(); modifyProject(this);">
                        <div><label>Title: <input type="text" name="title" value="${response.title}"/></label></div>
                        <div><label>Description: <input type="text" name="description" value="${response.description}"/></label></div>
                        <input type="hidden" name="id" value="${response.id}"/>
                        <div><input type="submit" value="modifier"/></div>
                    </form>
                    <button onclick="deleteProject(${response.id})">Supprimer</button>
                </li>
            `);
                } else {
                    console.error("La réponse JSON n'est pas au format attendu:", response);
                }
            },
            error: function(xhr, status, error) {
                console.error("Erreur lors de la création du projet. Détails de l'erreur:");
                console.error("Statut:", status);
                console.error("Erreur:", error);
                console.error("Réponse complète:", xhr.responseText);
            }
        });
    }
    function modifyProject(form) {
        const formData = $(form).serialize(); // Sérialise les données du formulaire
        const projectId = $(form).find("input[name='id']").val(); // Récupère l'ID du projet

        // Récupère le token CSRF depuis les balises meta
        const csrfToken = $("meta[name='_csrf']").attr("content");
        const csrfHeader = $("meta[name='_csrf_header']").attr("content");

        $.ajax({
            url: '/projects/modif',
            type: 'PUT',
            data: formData,
            beforeSend: function(xhr) {
                xhr.setRequestHeader(csrfHeader, csrfToken); // Ajoute le token CSRF dans l'en-tête
            },
            success: function(response) {
                // Met à jour le titre et la description du projet dans la liste
                const projectItem = $(`[data-project-id='${projectId}']`);
                projectItem.find('h3').text($(form).find("input[name='title']").val());
                projectItem.find('p').text($(form).find("input[name='description']").val());
            },
            error: function(error) {
                console.error("Erreur lors de la mise à jour du projet", error);
            }
        });
    }
</script>

</body>
</html>
